```
create table stock(
  id int not null auto_increment primary key comment "主键id",
  sku_id int not null unique key comment "sku id",
  count int not null comment "库存"
)engine = innodb comment "库存表";

create table order_item(
  id int not null auto_increment primary key comment "主键id",
  sku_id int not null comment "sku_id",
  user_name varchar(32) not null comment "下单用户名"
)engine=innodb comment "订单表";

insert into stock(sku_id,count) value(1234,1);  //在只有一个库存的情况下

```
## 一般的减库存逻辑
1.开启事务<br>
2.查库存<br>
3.判断库存<br>
4.将库存减一<br>
5.写订单<br>
6.写订单失败，回滚<br>
6.写订单成功，提交事务<br>
## 在repeatable read、read committed、read uncommitted级别下一般的减库存逻辑是会发生超卖的

||session A|session B|
|:---|:---|:---|
|1|begin|begin|
|2|select count from stock where sku_id = 1234;//得到库存为1|select count from stock where sku_id = 1234;//得到库存为1|
|3|stock>0|stock>0|
|4|update stock set count=count-1 where sku_id = 1234;||
|5||update stock set count=count-1 where sku_id = 1234;  //阻塞，因为session A没提交(排它锁与排它锁阻塞)，没释放锁|
|6|insert into order_item(sku_id,user_name) value(1234,"session A");  //写订单|继续阻塞|
|7|insert成功|继续阻塞|
|8|commit||
|9||update stock set count=count-1 where sku_id = 1234;|
|10||insert into order_item(sku_id,user_name) value(1234,"session B"); //写订单|
|11||commit|

session B会发生超卖，将库存减为-1
## 超卖的验证

```
开始sku_id为1234的商品有50个
mysql> select * from stock;
+----+--------+-------+
| id | sku_id | count |
+----+--------+-------+
|  1 |   1234 |    50 |
+----+--------+-------+
1 row in set (0.00 sec)
订单为空
mysql> select count(*) from order_item;
+----------+
| count(*) |
+----------+
|        0 |
+----------+
1 row in set (0.00 sec)

执行代码脚本

超卖出了2个
mysql> select count(*) from order_item;
+----------+
| count(*) |
+----------+
|       52 |
+----------+
1 row in set (0.01 sec)

mysql> select * from stock;
+----+--------+-------+
| id | sku_id | count |
+----+--------+-------+
|  1 |   1234 |    -2 |
+----+--------+-------+
1 row in set (0.01 sec)
````
## 在repeatable read、read committed、read uncommitted级别下共享锁也会是造成超卖
||session A|session B|
|:---|:---|:---|
|1|begin|begin|
|2|select count from stock where sku_id = 1234 lock in share mode;//得到库存为1|select count from stock where sku_id = 1234 lock in share mode;//得到库存为1|
|3|stock>0|stock>0|
|4|update stock set count=count-1 where sku_id = 1234;||
|5||update stock set count=count-1 where sku_id = 1234;  //阻塞，因为session A没提交(共享锁与排它锁阻塞)，没释放锁|
|6|insert into order_item(sku_id,user_name) value(1234,"session A");  //写订单|继续阻塞|
|7|insert成功|继续阻塞|
|8|commit||
|9||update stock set count=count-1 where sku_id = 1234;|
|10||insert into order_item(sku_id,user_name) value(1234,"session B"); //写订单|
|11||commit|

## 排它锁防止超卖

||session A|session B|
|:---|:---|:---|
|1|begin|begin|
|2|select count from stock where sku_id = 1234 for update;//得到库存为1|select count from stock where sku_id = 1234 for update;//阻塞|
|3|stock>0|继续阻塞(排它锁与排它锁阻塞)|
|4|update stock set count=count-1 where sku_id = 1234;|继续阻塞|
|6|insert into order_item(sku_id,user_name) value(1234,"session A");  //写订单|继续阻塞|
|7|insert成功|继续阻塞|
|8|commit||
|9||stock<=0 return false|
